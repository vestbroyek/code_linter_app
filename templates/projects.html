<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Linting App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>

</head>
<body>
    <div class="container">
        <h1>Welcome to the Code Linter!</h1>
        <div id="sidebar">
            <ul id="projectList">
                <!-- Use Jinja2 to loop through and render the projects -->
                {% for project in projects %}
                    <li>
                        <a href="/projects/{{ project.id }}" class="project-link">
                            <h3>{{ project.name }}</h3>
                        </a>
                        <p>ID: {{ project.id }}</p>
                        <p>Date Created: {{ project.date_created | format_date }}</p>
                        <img src="{{ project.image_link }}" alt="{{ project.name }}" style="width: 100px; height: 100px;" />
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div id="projectDetails">
            <!-- Project details will be displayed here -->
        </div>

        <div id="projectSnippets">
            <!-- Snippets will be displayed here when a project is clicked -->
        </div>

        <button id="addCodeButton">Add Code</button>

        <!-- Add a form to create a new project -->
        <form id="newProjectForm">
            <h2>Create a New Project:</h2>
            <label for="projectName">Name:</label>
            <input type="text" id="projectName" name="name" required><br><br>
        
            <label for="projectImage">Image Link:</label>
            <input type="text" id="projectImage" name="image_link"><br><br>
        
            <!-- Add a hidden input field for the timestamp -->
            <input type="hidden" id="dateCreated" name="date_created">
        
            <button type="submit">Create Project</button>
        </form>

        <!-- Add snippets form-->
        <div id="addCodeForm" class="hidden">
            <h2>Add Code:</h2>
            <form id="newCodeForm">
                <label for="codeText">Code:</label>
                <textarea id="codeText" name="code" required></textarea><br><br>
                <input type="hidden" id="codeProjectId" name="project_id">
                <input type="hidden" id="codeDateCreated" name="date_created">
                <button type="submit">Submit</button>
            </form>
        </div>
        
        <!-- TODO -->
        <!-- <button id="logoutButton">Log Out</button> -->
    </div>
    <script>
        // Function to extract the JWT token from the URL
        function extractTokenFromURL() {
            const hash = window.location.hash.substring(1); // Remove the '#' character
            const params = new URLSearchParams(hash);
            return params.get("access_token");
        }

        // Function to set the JWT token in the Authorization header
        function setAuthorizationHeader(token) {
            const headers = new Headers({
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/x-www-form-urlencoded'
            });
            return headers;
        }

        // Function to fetch projects with async/await
        async function fetchProjects() {
            const jwtToken = extractTokenFromURL();
            if (jwtToken) {
                const headers = setAuthorizationHeader(jwtToken);
                try {
                    const response = await fetch('/projects', { method: 'GET', headers });
                    // Handle the response here and render projects
                    const projectsData = await response.json();
                    renderProjects(projectsData);
                } catch (error) {
                    // Handle errors here
                    console.error("Error fetching projects:", error);
                }
            } else {
                // Handle the case when the token is not found in the URL
                console.error("JWT token not found in the URL.");
            }
        }

        // Function to render a list of projects
        function renderProjects(projects) {
            const projectList = document.getElementById("projectList");

            // Clear the current list
            projectList.innerHTML = "";

            // Iterate through the projects and add them to the list
            projects.forEach((project) => {
                const listItem = document.createElement("li");
                listItem.innerHTML = `
                    <h3>${project.name}</h3>
                    <p>ID: ${project.id}</p>
                    <p>Date Created: ${project.date_created.strftime('%Y-%m-%d')}</p>
                    <img src="${project.image_link}" alt="${project.name}" style="width: 50px; height: 50px;" />
                `;
                projectList.appendChild(listItem);
            });
        }

        // Function to get the current timestamp in ISO 8601 format (e.g., "2023-09-09T12:34:56Z")
        function getCurrentTimestamp() {
            return new Date().toISOString();
        }

        // Function for formatting date
        function formatDate(inputDate) {
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            return new Date(inputDate).toLocaleDateString(undefined, options);
        }

        // Event listener for the new project form submission
        const newProjectForm = document.getElementById("newProjectForm");
        newProjectForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Extract form data
            const formData = new FormData(newProjectForm);

            // Get the current timestamp
            const currentTimestamp = getCurrentTimestamp();

            // Add the current timestamp to the form data
            formData.append("date_created", currentTimestamp);

            // Construct the project object from form data
            const projectData = {};
            formData.forEach((value, key) => {
                projectData[key] = value;
            });

            // Send a POST request to create the new project
            const jwtToken = extractTokenFromURL();
            if (jwtToken) {
                const headers = {
                    'Authorization': `Bearer ${jwtToken}`,
                    'Content-Type': 'application/json'
                };

                console.log(headers)
                console.log(JSON.stringify(projectData))
                try {
                    const response = await fetch('/projects', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(projectData), // Corrected the variable name
                    });
                    // Handle the response here (e.g., refresh the project list)
                    fetchProjects();
                } catch (error) {
                    // Handle errors here
                    console.error("Error creating a new project:", error);
                }
            } else {
                // Handle the case when the token is not found in the URL
                console.error("JWT token not found in the URL.");
            }
        });

        // JavaScript code to handle project link click event
        document.addEventListener("DOMContentLoaded", function () {
            const projectLinks = document.querySelectorAll(".project-link");
            const projectDetailsContainer = document.getElementById("projectDetails");
            const projectSnippetsContainer = document.getElementById("projectSnippets");

            projectLinks.forEach((projectLink) => {
                projectLink.addEventListener("click", function (e) {
                    e.preventDefault(); // Prevent the default link behavior (navigation)

                    const href = this.getAttribute("href");
                    const projectId = href.split("/").pop();

                    fetch(`/projects/${projectId}`)
                        .then((response) => response.json())
                        .then((data) => {
                            // Access the project data
                            const projectData = JSON.parse(data.project);

                            // Display project details
                            projectDetailsContainer.innerHTML = `
                                <h2>${projectData.name}</h2>
                            `;

                            // Hide the "Create new project" form
                            newProjectForm.classList.add("hidden");

                            // Display snippets
                            if (projectData.snippets.length > 0) {
                                const snippetsList = document.createElement("div");
                                snippetsList.classList.add("snippet-list");
                                projectData.snippets.forEach((snippet) => {
                                    const snippetTile = document.createElement("div");
                                    snippetTile.classList.add("snippet-tile");
                                    snippetTile.innerHTML = `
                                        <div class="snippet-header">${formatDate(snippet.date_created)}</div>
                                        <div class="snippet-content">
                                            <pre><code class="language-python">${snippet.code}</code></pre>
                                        </div>
                                    `;
                                    snippetsList.appendChild(snippetTile);
                                });
                                projectSnippetsContainer.innerHTML = "";
                                projectSnippetsContainer.appendChild(snippetsList);
                            } else {
                                projectSnippetsContainer.innerHTML = "No snippets found for this project.";
                            }
                        })
                        .catch((error) => {
                            console.error("Error fetching project data:", error);
                        });
                });
            });
        });

        // Event listener to show the "Add Code" form
        const addCodeButton = document.getElementById("addCodeButton");
        const addCodeForm = document.getElementById("addCodeForm");

        addCodeButton.addEventListener("click", function () {
            addCodeForm.classList.remove("hidden");
        });

        // Event listener for submitting the "Add Code" form
        const newCodeForm = document.getElementById("newCodeForm");
        const codeProjectIdField = document.getElementById("codeProjectId");
        const codeDateCreatedField = document.getElementById("codeDateCreated");

        newCodeForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Extract form data
            const formData = new FormData(newCodeForm);

            // Get the current timestamp
            const currentTimestamp = new Date().toISOString();
            formData.append("date_created", currentTimestamp);

            // Set the project ID from the active project based on the clicked project link
            const href = document.querySelector(".project-link").getAttribute("href");
            const projectId = href.split("/").pop();
            formData.append("project_id", projectId);

            // Send a POST request to create the new code snippet
            const jwtToken = extractTokenFromURL();
            if (jwtToken) {
                const headers = {
                    'Authorization': `Bearer ${jwtToken}`,
                    'Content-Type': 'application/json'
                };

                try {
                    const response = await fetch(`/projects/${projectId}/snippets`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(Object.fromEntries(formData)),
                    });
                    // Handle the response here (e.g., refresh the snippets list)
                    // You can add code to refresh the snippets list when the snippet is added.
                } catch (error) {
                    // Handle errors here
                    console.error("Error adding code snippet:", error);
                }
            } else {
                // Handle the case when the token is not found in the URL
                console.error("JWT token not found in the URL.");
            }

            // Hide the form after submitting
            addCodeForm.classList.add("hidden");
        });

    </script>
</body>
</html>
